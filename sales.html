<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki ‚Äî Sales Dashboard</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a);
      color: var(--text);
      display: flex;
      min-height: 100vh;
    }
    /* Sidebar (same as index) */
    .sidebar {
      width: 200px;
      background: #111827;
      border-right: 1px solid #1f2937;
      padding: 20px;
    }
    .sidebar h2 { margin: 0 0 12px; font-size: 20px; }
    .menu-item { margin: 10px 0; }
    .menu-item a { color: var(--text); text-decoration: none; font-size: 16px; }
    .menu-item a:hover { text-decoration: underline; }

    /* Main content */
    .container {
      flex: 1;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }

    .filters {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
      background: var(--card); border:1px solid #1f2937; padding: 12px; border-radius: 12px;
      margin-bottom: 16px;
    }
    .filters label { color: var(--muted); font-size: 14px; }
    .filters input, .filters select {
      background: #0b1220; color: var(--text); border: 1px solid #1f2937; padding: 8px 10px; border-radius: 10px;
    }

    .kpis {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
    }
    @media (max-width: 900px){ .kpis { grid-template-columns: 1fr; } }

    .card {
      background: var(--card); border:1px solid #1f2937; border-radius: 16px; padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .kpi-title { color: var(--muted); font-size: 13px; letter-spacing: .3px; }
    .kpi-value { font-size: 26px; font-weight: 700; margin-top: 6px; }

    .note { color: var(--muted); font-size: 12px; margin-top: 12px; }
    .status { color: var(--muted); font-size: 12px; margin-top: 12px; white-space: pre-wrap; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <h2>Monki</h2>
    <div class="menu-item"><a href="index.html">üè† Home</a></div>
    <div class="menu-item"><a href="sales.html">üìä Sales Dashboard</a></div>
  </nav>

  <!-- Content -->
  <div class="container">
    <h1>Sales Dashboard</h1>
    <div class="subtitle">Filtros aplicados a todos los KPIs. Fechas en DD/MM/YYYY (por defecto: √∫ltimos 30 d√≠as). Producto: todos.</div>

    <div class="filters">
      <div>
        <label>Fecha inicio</label><br/>
        <input id="startDate" type="date" />
      </div>
      <div>
        <label>Fecha fin</label><br/>
        <input id="endDate" type="date" />
      </div>
      <div>
        <label>Producto</label><br/>
        <select id="productFilter"></select>
      </div>
      <div>
        <button id="applyBtn">Aplicar filtros</button>
      </div>
    </div>

    <div class="kpis">
      <div class="card">
        <div class="kpi-title">Total Sales (COP)</div>
        <div id="k_totalSales" class="kpi-value">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total Invoices</div>
        <div id="k_totalInvoices" class="kpi-value">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Average Ticket (COP / invoice)</div>
        <div id="k_avgTicket" class="kpi-value">$0</div>
      </div>

      <div class="card">
        <div class="kpi-title">Total Icecreams (units)</div>
        <div id="k_totalIcecreams" class="kpi-value">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Avg Toppings per Icecream</div>
        <div id="k_avgToppings" class="kpi-value">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Average Net Profit (%)</div>
        <div id="k_avgNetProfit" class="kpi-value">0%</div>
      </div>
    </div>

    <div id="status" class="status"></div>

    <div class="note">Fuentes: <code>headers.csv</code> + <code>reporte_utilidad.csv</code>. Los encabezados del reporte son reemplazados por la primera fila de <code>headers.csv</code> (por posici√≥n).</div>
  </div>

<script>
const HEADERS_FILE = 'headers.csv';
const DATA_FILE    = 'reporte_utilidad.csv';

// Column names: FIXED per user spec
const COL_TOTAL_GROSS = 'total_gross';
const COL_INVOICE     = 'invoice';
const COL_TOTAL_PURCH = 'total_purchase';
const COL_CATEGORY    = 'category';
const COL_QUANTITY    = 'quantity';
const COL_GROSS_PROD  = 'gross_prodit'; // as specified

// Date key (auto-detect like index page)
const DATE_KEY_CANDIDATES = ['date','fecha','fecha_creacion','fecha creaci√≥n'];
const PRODUCT_KEY_CANDS   = ['product','producto','item','item_name','nombre_producto'];

const statusEl = document.getElementById('status');

function logStatus(msg){
  statusEl.textContent += msg + '\\n';
}

function parseDateDMYFirst(v){
  if(v instanceof Date) return v;
  if(typeof v==='number') return new Date(v);
  if(typeof v==='string'){
    const s=v.trim();
    const m=s.match(/^(\\d{1,2})[\\/\\-\\.](\\d{1,2})[\\/\\-\\.](\\d{2,4})/);
    if(m){
      const dd=+m[1], mm=+m[2], yy=m[3].length===2 ? 2000+ +m[3] : +m[3];
      return new Date(yy, mm-1, dd);
    }
    const t=Date.parse(s);
    if(!isNaN(t)) return new Date(t);
  }
  return null;
}

function fmtCOP(v){ return new Intl.NumberFormat('es-CO', {style:'currency',currency:'COP',maximumFractionDigits:0}).format(v||0); }
function fmtPct(v){ return (v||0).toFixed(1).replace('.',',') + '%'; }

function findKey(headers, candidates){
  const lower=headers.map(h=>String(h||'').trim().toLowerCase());
  for(const c of candidates){
    const i=lower.indexOf(c.toLowerCase());
    if(i!==-1) return headers[i];
  }
  return null;
}

function num(x){
  if(x==null) return 0;
  if(typeof x==='number') return isFinite(x)?x:0;
  if(typeof x==='string'){
    const n=Number(x.replace(/[^0-9.-]/g,''));
    return isFinite(n)?n:0;
  }
  return 0;
}

function parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url+'?v='+Date.now(),{
      download:true, header:false, dynamicTyping:false, skipEmptyLines:true,
      complete:res=>resolve(res.data),
      error:err=>reject(err)
    });
  });
}

(async function init(){
  try{
    logStatus('Cargando CSV‚Ä¶');
    const hdrRows  = await parseCSV(HEADERS_FILE);
    const dataRows = await parseCSV(DATA_FILE);

    if(!hdrRows.length) throw new Error('headers.csv vac√≠o');
    if(!dataRows.length) throw new Error('reporte_utilidad.csv vac√≠o');

    // Replace headers by position using first row of headers.csv
    const canonical = hdrRows[0].map(x=>(x??'').toString());
    const width = Math.max((dataRows[0]||[]).length, canonical.length);
    dataRows[0] = Array.from({length: width}, (_,i)=> canonical[i] ?? (dataRows[0]||[])[i] ?? ('col'+(i+1)));

    const headers = dataRows[0];
    const rows = dataRows.slice(1).map(r=>{const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });

    // Keys
    const dateKey    = findKey(headers, DATE_KEY_CANDIDATES) || headers[0];
    const productKey = findKey(headers, PRODUCT_KEY_CANDS)   || 'product';

    // Build min/max date + default 30-day window
    const dates = rows.map(r=>parseDateDMYFirst(r[dateKey])).filter(Boolean).sort((a,b)=>a-b);
    if(!dates.length){ throw new Error('No hay fechas v√°lidas'); }
    const maxDate = dates[dates.length-1];
    const minDefault = new Date(maxDate); minDefault.setDate(maxDate.getDate()-29);

    const iso = d => d.toISOString().slice(0,10);
    const $start = document.getElementById('startDate');
    const $end   = document.getElementById('endDate');
    $start.value = iso(minDefault);
    $end.value   = iso(maxDate);

    // Product list
    const $prod = document.getElementById('productFilter');
    const uniq = Array.from(new Set(rows.map(r=> (r[productKey]??'').toString().trim()))).filter(s=>s.length>0).sort((a,b)=>a.localeCompare(b));
    const optAll = document.createElement('option'); optAll.value='__ALL__'; optAll.textContent='Todos los productos'; $prod.appendChild(optAll);
    uniq.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; $prod.appendChild(o); });
    $prod.value='__ALL__';

    function applyFilters(){
      const start = new Date($start.value+'T00:00:00');
      const end   = new Date($end.value  +'T23:59:59');
      const prod  = $prod.value;

      const filtered = rows.filter(r=>{
        const d = parseDateDMYFirst(r[dateKey]);
        if(!d) return false;
        if(d < start || d > end) return false;
        if(prod !== '__ALL__'){
          const p = (r[productKey]??'').toString().trim();
          if(p !== prod) return false;
        }
        return true;
      });

      computeKPIs(filtered);
    }

    function computeKPIs(data){
      // Totals / sums
      let totalSalesCOP = 0;
      let totalIcecreams = 0;
      let totalToppings  = 0;
      let sumGrossProdit = 0;

      // Invoices set and invoice->total_purchase map (for AvgTicket)
      const invoices = new Set();
      const invoicePurchase = new Map(); // invoice -> total_purchase (last seen)

      for(const r of data){
        totalSalesCOP += num(r[COL_TOTAL_GROSS]);
        sumGrossProdit += num(r[COL_GROSS_PROD]);

        const inv = (r[COL_INVOICE]??'').toString();
        if(inv) invoices.add(inv);

        const tp = num(r[COL_TOTAL_PURCH]);
        if(inv) invoicePurchase.set(inv, tp);

        const cat = (r[COL_CATEGORY]??'').toString().trim().toLowerCase();
        const qty = num(r[COL_QUANTITY]);

        if(cat === 'helados'){
          totalIcecreams += qty;
        }else if(cat === 'toppings'){
          totalToppings  += qty;
        }
      }

      const totalInvoices = invoices.size;
      // Avg ticket: average across unique invoices of their total_purchase
      let avgTicket = 0;
      if(totalInvoices > 0){
        let s = 0;
        for(const inv of invoices){
          s += (invoicePurchase.get(inv) || 0);
        }
        avgTicket = s / totalInvoices;
      }

      // Avg toppings per icecream
      const avgToppings = totalIcecreams > 0 ? (totalToppings / totalIcecreams) : 0;

      // Average net profit (%) = (sum of gross_prodit) / Total Sales * 100
      let avgNetProfitPct = 0;
      if(totalSalesCOP > 0){
        avgNetProfitPct = (sumGrossProdit / totalSalesCOP) * 100;
      }

      // Update UI
      document.getElementById('k_totalSales').textContent    = fmtCOP(totalSalesCOP);
      document.getElementById('k_totalInvoices').textContent = totalInvoices.toLocaleString('es-CO');
      document.getElementById('k_avgTicket').textContent     = fmtCOP(avgTicket);
      document.getElementById('k_totalIcecreams').textContent= totalIcecreams.toLocaleString('es-CO');
      document.getElementById('k_avgToppings').textContent   = (Math.round(avgToppings*100)/100).toLocaleString('es-CO');
      document.getElementById('k_avgNetProfit').textContent  = fmtPct(avgNetProfitPct);
    }

    document.getElementById('applyBtn').addEventListener('click', applyFilters);

    // Initial compute with defaults
    applyFilters();
    logStatus('Listo.');
  }catch(e){
    logStatus('Error: '+(e && e.message ? e.message : e));
  }
})();
</script>
</body>
</html>
