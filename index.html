<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki — Dashboard Ventas (Barras en miles)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Data labels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <!-- Papaparse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      margin: 0; padding: 20px;
      font-family: system-ui, sans-serif;
      background: #0f172a; color: #e5e7eb;
    }
    h1 { margin-top: 0; }
    select { padding: 6px 10px; }
    .kpis { display: flex; gap: 16px; margin: 20px 0; }
    .kpi-box { background:#111827; padding:14px; border-radius:10px; border:1px solid #1f2937; }
    canvas { background:#111827; border-radius:10px; padding:10px; }
  </style>
</head>

<body>
  <h1>Dashboard Ventas — Monki (miles de COP)</h1>

  <label>Fecha de corte: </label>
  <select id="endDate"></select>

  <div class="kpis">
    <div class="kpi-box">
      Último día: <b><span id="kpi1"></span></b>
    </div>
    <div class="kpi-box">
      Últimos 7 días: <b><span id="kpi7"></span></b>
    </div>
    <div class="kpi-box">
      Últimos 30 días: <b><span id="kpi30"></span></b>
    </div>
  </div>

  <h2>Mensual</h2>
  <canvas id="chartMonthly"></canvas>

  <h2>Semanal</h2>
  <canvas id="chartWeekly"></canvas>

<script>
Chart.register(ChartDataLabels);

const HEADERS_FILE = 'headers.csv';
const DATA_FILE    = 'reporte_utilidad.csv';

function fmtDMY(d){
  return String(d.getDate()).padStart(2,'0') + '/' +
         String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
}
function fmtMY(d){
  return String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
}
function ymdISO(d){
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function parseDate(v){
  if(v instanceof Date) return v;
  if(typeof v==='string'){
    const m=v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if(m){
      let dd=+m[1], mm=+m[2], yy=m[3].length===2?2000+ +m[3]:+m[3];
      return new Date(yy,mm-1,dd);
    }
  }
  return null;
}

async function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url+'?v='+Date.now(),{
      download:true, header:false, dynamicTyping:false, skipEmptyLines:true,
      complete:res=>resolve(res.data), error:err=>reject(err)
    });
  });
}

function sumWindow(daily,endISO,days){
  const end=new Date(endISO+'T00:00:00');
  const start=new Date(end); start.setDate(end.getDate()-(days-1));
  let total=0;
  for(const[iso,val] of daily){
    const d=new Date(iso+'T00:00:00');
    if(d>=start && d<=end) total+=val;
  }
  return total;
}

(async function main(){
  const hdr = await loadCSV(HEADERS_FILE);
  const dat = await loadCSV(DATA_FILE);

  const canonical = hdr[0].map(x=>String(x||''));
  const width=Math.max((dat[0]||[]).length,canonical.length);
  dat[0] = Array.from({length:width},(_,i)=>canonical[i] ?? dat[0][i] ?? ('col'+(i+1)));

  const headers = dat[0];
  const rows = dat.slice(1).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });

  const dateKey  = headers.find(h=>/fecha|date/i.test(h)) || headers[0];
  const salesKey = headers.find(h=>/total/i.test(h))     || headers[1];

  // Build daily totals
  const dailyMap=new Map();
  for(const r of rows){
    const d=parseDate(r[dateKey]);
    if(!d) continue;
    let v=r[salesKey];
    if(typeof v==='string') v=Number(v.replace(/[^0-9.-]/g,''));
    if(!isFinite(v)) continue;
    const key=ymdISO(d);
    dailyMap.set(key,(dailyMap.get(key)||0)+v);
  }
  const daily=[...dailyMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  if(!daily.length){ alert("No data"); return; }

  // End date selector
  const sel=document.getElementById('endDate');
  daily.forEach(([iso])=>{
    const d=new Date(iso+'T00:00:00');
    const o=document.createElement('option');
    o.value=iso; o.textContent=fmtDMY(d);
    sel.appendChild(o);
  });
  sel.value=daily[daily.length-1][0];

  function refreshKPIs(){
    const end=sel.value;
    document.getElementById('kpi1').textContent =(sumWindow(daily,end,1 )/1000).toLocaleString('es-CO');
    document.getElementById('kpi7').textContent =(sumWindow(daily,end,7 )/1000).toLocaleString('es-CO');
    document.getElementById('kpi30').textContent=(sumWindow(daily,end,30)/1000).toLocaleString('es-CO');
  }
  refreshKPIs();
  sel.addEventListener('change', refreshKPIs);

  // Aggregations
  function buildMonthly(){
    const m=new Map();
    for(const[iso,val] of daily){
      const d=new Date(iso+'T00:00:00');
      const key=ymdISO(new Date(d.getFullYear(),d.getMonth(),1));
      m.set(key,(m.get(key)||0)+val);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }
  function monday(d){
    const day=d.getDay();
    const diff=(day===0?-6:1-day);
    const m=new Date(d);
    m.setDate(d.getDate()+diff);
    m.setHours(0,0,0,0);
    return m;
  }
  function buildWeekly(){
    const m=new Map();
    for(const[iso,val] of daily){
      const d=new Date(iso+'T00:00:00');
      const mon=ymdISO(monday(d));
      m.set(mon,(m.get(mon)||0)+val);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }

  const monthly=buildMonthly();
  const weekly =buildWeekly();

  new Chart(document.getElementById('chartMonthly'),{
    type:'bar',
    data:{
      labels: monthly.map(e=>fmtMY(new Date(e[0]+'T00:00:00'))),
      datasets:[{
        data: monthly.map(e=>e[1]/1000),
        backgroundColor:'#4ade80'
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{
          anchor:'end', align:'end',
          formatter:v=>v.toLocaleString('es-CO')
        }
      },
      scales:{y:{beginAtZero:true}}
    }
  });

  new Chart(document.getElementById('chartWeekly'),{
    type:'bar',
    data:{
      labels: weekly.map(e=>fmtDMY(new Date(e[0]+'T00:00:00'))),
      datasets:[{
        data: weekly.map(e=>e[1]/1000),
        backgroundColor:'#60a5fa'
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{
          anchor:'end', align:'end',
          formatter:v=>v.toLocaleString('es-CO')
        }
      },
      scales:{y:{beginAtZero:true}}
    }
  });

})();
</script>

</body>
</html>
