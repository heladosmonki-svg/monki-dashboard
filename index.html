<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki — Dashboard de Ventas (CSV, Barras Simples)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    select { background: var(--card); color: var(--text); border: 1px solid #1f2937; padding: 8px 10px; border-radius: 10px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2937; padding: 16px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); min-height: 100px; }
    .kpi-title { color: var(--muted); font-size: 13px; letter-spacing: .3px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .legend { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .chart-card { margin-top: 18px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    canvas { width: 100% !important; height: auto !important; }
    .warn { color: #fbbf24; }
    .err  { color: #f87171; }
    .ok   { color: #34d399; }
    pre.log { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:10px; color:#cbd5e1; overflow:auto }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Ventas — Monki (CSV, barras simples)</h1>
    <div class="subtitle">
      <strong>headers.csv</strong> (primera fila = encabezados canónicos por posición) +
      <strong>reporte_utilidad.csv</strong> (datos). Reemplaza headers por posición y calcula totales de <b>1</b>, <b>7</b> y <b>30</b> días.
    </div>

    <div class="controls">
      <label for="endDate">Fecha de corte:</label>
      <select id="endDate"></select>
      <span id="lastDate" class="legend"></span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="kpi-title">Total ventas último día</div>
        <div id="kpi1" class="kpi-value">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 7 días</div>
        <div id="kpi7" class="kpi-value">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 30 días</div>
        <div id="kpi30" class="kpi-value">$0</div>
      </div>
    </div>

    <!-- Monthly bar chart FIRST -->
    <div class="card chart-card">
      <div class="kpi-title">Ventas mensuales</div>
      <canvas id="chartMonthly"></canvas>
      <div class="legend">Agregado por mes calendario (<code>MM/YYYY</code>).</div>
    </div>

    <!-- Weekly bar chart SECOND (Mon–Sun) -->
    <div class="card chart-card">
      <div class="kpi-title">Ventas semanales (lunes a domingo)</div>
      <canvas id="chartWeekly"></canvas>
      <div class="legend">Etiqueta = lunes de cada semana (<code>DD/MM/YYYY</code>).</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="kpi-title">Estado</div>
      <div id="status" class="legend"></div>
      <pre id="log" class="log"></pre>
    </div>

    <div class="footer">
      Estructura: <code>index.html</code>, <code>headers.csv</code>, <code>reporte_utilidad.csv</code>.
    </div>
  </div>

<script>
  const HEADERS_FILE = 'headers.csv';
  const DATA_FILE    = 'reporte_utilidad.csv';

  const DATE_KEY_CANDIDATES  = ['date','fecha','fecha_creacion','fecha creación'];
  const SALES_KEY_CANDIDATES = ['total_purchase_per_product','total','total_gross','total.1','total_purchase'];

  const statusDiv = document.getElementById('status');
  const logEl     = document.getElementById('log');
  const log       = (...a) => logEl.textContent += a.join(' ') + '\\n';
  const setStatus = (t,c='') => { statusDiv.innerHTML=t; statusDiv.className='legend '+c; };

  const fmtCOP = v => new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(v||0);

  // ---- Display helpers (DD/MM/YYYY) ----
  function fmtDMY(d){
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  function fmtMY(d){
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    return `${mm}/${yyyy}`;
  }
  function ymdISO(d){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // ---- Parse D/M/Y first ----
  function parseDateDMYFirst(v){
    if(v instanceof Date) return v;
    if(typeof v==='number') return new Date(v);
    if(typeof v==='string'){
      const s = v.trim();
      const m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if(m){
        let dd = parseInt(m[1],10);
        let mm = parseInt(m[2],10);
        let yy = m[3].length===2 ? (2000 + parseInt(m[3],10)) : parseInt(m[3],10);
        let HH = m[4]!=null ? parseInt(m[4],10) : 0;
        let MI = m[5]!=null ? parseInt(m[5],10) : 0;
        let SS = m[6]!=null ? parseInt(m[6],10) : 0;
        return new Date(yy, mm-1, dd, HH, MI, SS);
      }
      const t = Date.parse(s);
      if(!isNaN(t)) return new Date(t);
    }
    return null;
  }

  // ---- Header helpers ----
  function findKey(headers,cands){
    const lower = headers.map(h=>String(h||'').trim().toLowerCase());
    for(const c of cands){
      const i = lower.indexOf(c.toLowerCase());
      if(i!==-1) return headers[i];
    }
    return null;
  }

  // ---- Aggregations ----
  function buildDaily(rows,dateKey,salesKey){
    const m=new Map(); // key: ISO yyyy-mm-dd -> sum
    for(const r of rows){
      const d=parseDateDMYFirst(r[dateKey]);
      if(!d) continue;
      let v=r[salesKey];
      if(v==null) continue;
      if(typeof v==='string') v=Number(v.replace(/[^0-9.-]/g,''));
      if(!isFinite(v)) continue;
      const key=ymdISO(new Date(d.getFullYear(),d.getMonth(),d.getDate()));
      m.set(key,(m.get(key)||0)+v);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function getMonday(d) {
    const day = d.getDay(); // 0=Sun,1=Mon,...
    const diff = (day === 0 ? -6 : 1 - day);
    const monday = new Date(d);
    monday.setDate(d.getDate() + diff);
    monday.setHours(0,0,0,0);
    return monday;
  }

  function buildWeeklyFromDaily(dailyEntries){
    const m=new Map(); // Monday (ISO) -> sum
    for(const [iso, val] of dailyEntries){
      const d=new Date(iso+'T00:00:00');
      const mon=ymdISO(getMonday(d));
      m.set(mon,(m.get(mon)||0)+val);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function buildMonthlyFromDaily(dailyEntries){
    const m=new Map(); // first day of month (ISO) -> sum
    for(const [iso, val] of dailyEntries){
      const d=new Date(iso+'T00:00:00');
      const key=ymdISO(new Date(d.getFullYear(), d.getMonth(), 1));
      m.set(key,(m.get(key)||0)+val);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function sumWindow(dailyEntries,endISO,days){
    const end=new Date(endISO+'T00:00:00');
    const start=new Date(end);
    start.setDate(end.getDate()-(days-1));
    let s=0;
    for(const[iso,v] of dailyEntries){
      const d=new Date(iso+'T00:00:00');
      if(d>=start&&d<=end) s+=v;
    }
    return s;
  }

  function populateDates(dailyEntries){
    const sel=document.getElementById('endDate');
    sel.innerHTML='';
    dailyEntries.forEach(([iso])=>{
      const d=new Date(iso+'T00:00:00');
      const o=document.createElement('option');
      o.value=iso;          // keep ISO for logic
      o.textContent=fmtDMY(d); // show DD/MM/YYYY
      sel.appendChild(o);
    });
    if(dailyEntries.length) sel.value=dailyEntries[dailyEntries.length-1][0];
    const lastISO = dailyEntries.length ? dailyEntries[dailyEntries.length-1][0] : null;
    document.getElementById('lastDate').textContent = lastISO ? ('Última fecha: '+fmtDMY(new Date(lastISO+'T00:00:00'))) : '';
  }

  let chartMonthly, chartWeekly;
  function renderMonthly(entries){
    const ctx=document.getElementById('chartMonthly');
    const labels=entries.map(e=>fmtMY(new Date(e[0]+'T00:00:00')));
    const data  =entries.map(e=>e[1]);
    if(chartMonthly) chartMonthly.destroy();
    chartMonthly=new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[{ label:'Ventas mensuales (COP)', data }]},
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }
  function renderWeekly(entries){
    const ctx=document.getElementById('chartWeekly');
    const labels=entries.map(e=>fmtDMY(new Date(e[0]+'T00:00:00')));
    const data  =entries.map(e=>e[1]);
    if(chartWeekly) chartWeekly.destroy();
    chartWeekly=new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[{ label:'Ventas semanales (COP)', data }]},
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function refreshKpis(dailyEntries){
    const endISO=document.getElementById('endDate').value;
    document.getElementById('kpi1').textContent  = fmtCOP(sumWindow(dailyEntries,endISO,1));
    document.getElementById('kpi7').textContent  = fmtCOP(sumWindow(dailyEntries,endISO,7));
    document.getElementById('kpi30').textContent = fmtCOP(sumWindow(dailyEntries,endISO,30));
  }

  function parseCSV(url){
    return new Promise((resolve,reject)=>{
      Papa.parse(url+'?v='+Date.now(),{
        download:true, header:false, dynamicTyping:false, skipEmptyLines:true,
        complete: res => resolve(res.data),
        error: err => reject(err)
      });
    });
  }

  (async function init(){
    try{
      setStatus('Cargando CSV…');
      const hdrRows  = await parseCSV(HEADERS_FILE);
      const dataRows = await parseCSV(DATA_FILE);

      if(!hdrRows.length) throw new Error('headers.csv está vacío.');
      if(!dataRows.length) throw new Error('reporte_utilidad.csv está vacío.');

      // Replace report header by canonical (by position)
      const canonical = hdrRows[0].map(x=>(x??'').toString());
      const width = Math.max((dataRows[0]||[]).length, canonical.length);
      dataRows[0] = Array.from({length: width}, (_,i)=> canonical[i] ?? (dataRows[0]||[])[i] ?? ('col'+(i+1)));

      // Convert to objects
      const rows = (function(rows){
        const headers = rows[0].map(h=>(h??'').toString());
        return rows.slice(1).map(r=>{
          const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;
        });
      })(dataRows);

      const headers = Object.keys(rows[0]||{});
      const dateKey  = findKey(headers, DATE_KEY_CANDIDATES)  || headers[0];
      const salesKey = findKey(headers, SALES_KEY_CANDIDATES) || headers.find(h=>String(h).toLowerCase().includes('total')) || headers[1];

      const dailyEntries = buildDaily(rows,dateKey,salesKey);
      if(!dailyEntries.length){ setStatus('No se encontraron filas con datos válidos.', 'warn'); return; }

      populateDates(dailyEntries);
      refreshKpis(dailyEntries);
      document.getElementById('endDate').addEventListener('change', ()=>refreshKpis(dailyEntries));

      const monthlyEntries = buildMonthlyFromDaily(dailyEntries);
      const weeklyEntries  = buildWeeklyFromDaily(dailyEntries);

      renderMonthly(monthlyEntries); // first
      renderWeekly(weeklyEntries);   // second

      setStatus('OK', 'ok');
      log('Headers usados:', headers.join(' | '));
      log('Fecha (lectura D/M/Y):', dateKey, ' • Ventas:', salesKey);
    }catch(e){
      setStatus('Error: '+e.message, 'err');
      log('Error:', e.stack || e.message);
    }
  })();
</script>
</body>
</html>
