<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki — Dashboard de Ventas (CSV)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    select { background: var(--card); color: var(--text); border: 1px solid #1f2937; padding: 8px 10px; border-radius: 10px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2937; padding: 16px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); min-height: 100px; }
    .kpi-title { color: var(--muted); font-size: 13px; letter-spacing: .3px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .legend { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .chart-card { margin-top: 18px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    canvas { width: 100% !important; height: auto !important; }
    .warn { color: #fbbf24; }
    .err  { color: #f87171; }
    .ok   { color: #34d399; }
    pre.log { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:10px; color:#cbd5e1; overflow:auto }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse for robust CSV parsing (auto delimiter detection, quoted fields, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Ventas — Monki (CSV)</h1>
    <div class="subtitle">
      <strong>headers.csv</strong> (primera fila = encabezados canónicos por posición) +
      <strong>reporte_utilidad.csv</strong> (datos).<br>
      El panel reemplaza los headers del reporte con los de <code>headers.csv</code> y calcula totales de <b>1</b>, <b>7</b> y <b>30</b> días.
    </div>

    <div class="controls">
      <label for="endDate">Fecha de corte:</label>
      <select id="endDate"></select>
      <span id="lastDate" class="legend"></span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="kpi-title">Total ventas último día</div>
        <div id="kpi1" class="kpi-value">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 7 días</div>
        <div id="kpi7" class="kpi-value">$0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 30 días</div>
        <div id="kpi30" class="kpi-value">$0</div>
      </div>
    </div>

    <div class="card chart-card">
      <div class="kpi-title">Ventas diarias</div>
      <canvas id="chart"></canvas>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="kpi-title">Estado</div>
      <div id="status" class="legend"></div>
      <pre id="log" class="log"></pre>
    </div>

    <div class="footer">
      Coloca en la raíz del repo: <code>index.html</code>, <code>headers.csv</code>, <code>reporte_utilidad.csv</code>.
    </div>
  </div>

<script>
  const HEADERS_FILE = 'headers.csv';
  const DATA_FILE    = 'reporte_utilidad.csv';

  // After header replacement, try these keys. Default sales uses the line-total incl. taxes: total_purchase_per_product.
  const DATE_KEY_CANDIDATES  = ['date','fecha','fecha_creacion','fecha creación'];
  const SALES_KEY_CANDIDATES = ['total_purchase_per_product','total','total_gross','total.1','total_purchase'];

  const statusDiv = document.getElementById('status');
  const logEl     = document.getElementById('log');
  const log       = (...a) => logEl.textContent += a.join(' ') + '\\n';
  const setStatus = (t,c='') => { statusDiv.innerHTML=t; statusDiv.className='legend '+c; };

  const fmtCOP = v => new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(v||0);

  function ymd(d){
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseDate(v){
    if(v instanceof Date) return v;
    if(typeof v==='number') return new Date(v);
    if(typeof v==='string'){
      // Try ISO/US first
      let t=Date.parse(v);
      if(!isNaN(t)) return new Date(t);
      // Try DD/MM/YYYY
      const m=v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const d=Number(m[1]), mo=Number(m[2]), y=Number(m[3]);
        return new Date(y, mo-1, d);
      }
    }
    return null;
  }

  function aoaToObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h => (h ?? '').toString());
    return rows.slice(1).map(r => {
      const o={};
      headers.forEach((h,i)=>o[h]=r[i]);
      return o;
    });
  }

  function findKey(headers,cands){
    const lower = headers.map(h=>String(h||'').trim().toLowerCase());
    for(const c of cands){
      const i = lower.indexOf(c.toLowerCase());
      if(i!==-1) return headers[i];
    }
    return null;
  }

  function replaceHeaders(dataRows, canonical){
    if(!dataRows.length) return dataRows;
    const width = Math.max(dataRows[0].length, canonical.length);
    const newH=[];
    for(let i=0;i<width;i++) newH[i]=canonical[i]??dataRows[0][i]??('col'+(i+1));
    dataRows[0]=newH;
    return dataRows;
  }

  function buildDaily(rows,dateKey,salesKey){
    const m=new Map();
    for(const r of rows){
      const d=parseDate(r[dateKey]);
      if(!d) continue;
      let v=r[salesKey];
      if(v==null) continue;
      if(typeof v==='string') v=Number(v.replace(/[^0-9.-]/g,'')); // strip $ and thousand separators
      if(!isFinite(v)) continue;
      const ds=ymd(new Date(d.getFullYear(),d.getMonth(),d.getDate()));
      m.set(ds,(m.get(ds)||0)+v);
    }
    return [...m.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  }

  function sumWindow(entries,endStr,days){
    const end=new Date(endStr+'T00:00:00');
    const start=new Date(end);
    start.setDate(end.getDate()-(days-1));
    let s=0;
    for(const[ds,v] of entries){
      const d=new Date(ds+'T00:00:00');
      if(d>=start&&d<=end) s+=v;
    }
    return s;
  }

  function populateDates(entries){
    const sel=document.getElementById('endDate');
    sel.innerHTML='';
    entries.forEach(([ds])=>{
      const o=document.createElement('option');
      o.value=ds; o.textContent=ds;
      sel.appendChild(o);
    });
    if(entries.length) sel.value=entries[entries.length-1][0];
    document.getElementById('lastDate').textContent=entries.length?'Última fecha: '+entries[entries.length-1][0]:'';
  }

  let chart;
  function renderChart(entries){
    const ctx=document.getElementById('chart');
    const labels=entries.map(e=>e[0]);
    const data  =entries.map(e=>e[1]);
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label:'Ventas diarias (COP)',data,tension:0.2}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{
        x:{ticks:{autoSkip:true,maxTicksLimit:10}},y:{beginAtZero:true}
      }}
    });
  }

  function refreshKpis(entries){
    const endStr=document.getElementById('endDate').value;
    document.getElementById('kpi1').textContent = fmtCOP(sumWindow(entries,endStr,1));
    document.getElementById('kpi7').textContent = fmtCOP(sumWindow(entries,endStr,7));
    document.getElementById('kpi30').textContent= fmtCOP(sumWindow(entries,endStr,30));
  }

  function parseCSV(url){
    return new Promise((resolve,reject)=>{
      Papa.parse(url+'?v='+Date.now(),{
        download:true, header:false, dynamicTyping:false, skipEmptyLines:true,
        complete: res => resolve(res.data),
        error: err => reject(err)
      });
    });
  }

  (async function init(){
    try{
      setStatus('Cargando CSV…');
      const hdrRows  = await parseCSV(HEADERS_FILE);
      const dataRows = await parseCSV(DATA_FILE);

      if(!hdrRows.length) throw new Error('headers.csv está vacío.');
      if(!dataRows.length) throw new Error('reporte_utilidad.csv está vacío.');

      replaceHeaders(dataRows, hdrRows[0]);
      const rows = aoaToObjects(dataRows);
      const headers = Object.keys(rows[0]||{});
      const dateKey  = findKey(headers, DATE_KEY_CANDIDATES)  || headers[0];
      const salesKey = findKey(headers, SALES_KEY_CANDIDATES) || headers.find(h=>String(h).toLowerCase().includes('total')) || headers[1];

      const entries = buildDaily(rows,dateKey,salesKey);
      if(!entries.length){ setStatus('No se encontraron filas con datos válidos.', 'warn'); return; }

      populateDates(entries);
      renderChart(entries);
      refreshKpis(entries);
      document.getElementById('endDate').addEventListener('change', ()=>refreshKpis(entries));

      setStatus('OK', 'ok');
      log('Headers usados:', headers.join(' | '));
      log('Columna fecha →', dateKey, ' • Columna ventas →', salesKey);
    }catch(e){
      setStatus('Error: '+e.message, 'err');
      log('Error:', e.stack || e.message);
    }
  })();
</script>
</body>
</html>
