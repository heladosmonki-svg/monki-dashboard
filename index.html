<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki — Dashboard de Ventas (con headers.xlsx)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a); color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    .subtitle { color: var(--muted); margin-bottom: 20px; }
    .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    select { background: var(--card); color: var(--text); border: 1px solid #1f2937; padding: 8px 10px; border-radius: 10px; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2937; padding: 16px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); min-height: 100px; }
    .kpi-title { color: var(--muted); font-size: 13px; letter-spacing: .3px; }
    .kpi-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
    .legend { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .chart-card { margin-top: 18px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 18px; }
    canvas { width: 100% !important; height: auto !important; }
    .warn { color: #fbbf24; }
    .err  { color: #f87171; }
    .ok   { color: #34d399; }
    pre.log { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:10px; color:#cbd5e1; overflow:auto }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Ventas — Monki</h1>
    <div class="subtitle">
      Este panel lee <code>reporte_utilidad.xlsx</code> y reemplaza sus encabezados
      con los de <code>headers.xlsx</code> (por <strong>posición</strong>), luego calcula 1, 7 y 30 días.
    </div>

    <div class="controls">
      <label for="endDate">Fecha de corte:</label>
      <select id="endDate"></select>
      <span id="lastDate" class="legend"></span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="kpi-title">Total ventas último día</div>
        <div id="kpi1" class="kpi-value">$0</div>
        <div class="legend">Incluye impuestos (bruto)</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 7 días</div>
        <div id="kpi7" class="kpi-value">$0</div>
        <div class="legend">Incluye impuestos (bruto)</div>
      </div>
      <div class="card">
        <div class="kpi-title">Total ventas últimos 30 días</div>
        <div id="kpi30" class="kpi-value">$0</div>
        <div class="legend">Incluye impuestos (bruto)</div>
      </div>
    </div>

    <div class="card chart-card">
      <div class="kpi-title">Ventas diarias</div>
      <canvas id="chart"></canvas>
      <div class="legend">Necesario: <code>headers.xlsx</code> (primera fila = nombres canónicos).</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="kpi-title">Estado</div>
      <div id="status" class="legend"></div>
      <pre id="log" class="log"></pre>
    </div>

    <div class="footer">
      Estructura del repo (raíz): <code>index.html</code>, <code>reporte_utilidad.xlsx</code>, <code>headers.xlsx</code>.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const EXCEL_FILE   = 'reporte_utilidad.xlsx';
    const HEADERS_FILE = 'headers.xlsx';

    // After replacement, we try these candidates to find date and gross sales keys.
    // You can adjust these if your canonical headers use other names.
    const DATE_KEY_CANDIDATES  = ['date', 'fecha', 'fecha_creacion', 'fecha creación'];
    const SALES_KEY_CANDIDATES = ['total', 'total_purchase_per_product', 'total_gross', 'total.1', 'total_purchase'];

    const statusDiv = document.getElementById('status');
    const logEl = document.getElementById('log');
    const log = (...args) => { logEl.textContent += args.join(' ') + '\\n'; };
    const setStatus = (html, cls='') => { statusDiv.innerHTML = html; statusDiv.className = 'legend ' + cls; };

    const fmtCOP = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(v || 0);

    function ymd(d) {
      const yyyy = d.getFullYear(); const mm = String(d.getMonth() + 1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseDate(val) {
      if (val instanceof Date) return val;
      if (typeof val === 'number') { // Excel serial
        const epoch = new Date(Date.UTC(1899, 11, 30));
        return new Date(epoch.getTime() + val * 86400000);
      }
      if (typeof val === 'string') {
        const t = Date.parse(val);
        if (!isNaN(t)) return new Date(t);
        const m1 = val.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m1) return new Date(`${m1[1]}-${m1[2]}-${m1[3]}T00:00:00`);
        const m2 = val.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (m2) return new Date(`${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}T00:00:00`);
      }
      return null;
    }

    function aoaToObjects(rows) {
      // rows: array-of-arrays, rows[0] = header row
      if (!rows || !rows.length) return [];
      const headers = (rows[0] || []).map(h => (h ?? '').toString());
      const out = [];
      for (let i = 1; i < rows.length; i++) {
        const r = rows[i] || [];
        const obj = {};
        for (let j = 0; j < headers.length; j++) obj[headers[j]] = r[j];
        out.push(obj);
      }
      return out;
    }

    function findKey(headers, candidates) {
      const lower = headers.map(h => (h||'').toString().trim().toLowerCase());
      for (const c of candidates) {
        const idx = lower.indexOf(c.toLowerCase());
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    async function fetchArrayBuffer(url) {
      const u = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
      log('Fetching:', u);
      const resp = await fetch(u, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
      return await resp.arrayBuffer();
    }

    async function loadAoaFromXlsx(url) {
      const buf = await fetchArrayBuffer(url);
      const wb = XLSX.read(buf, { type: 'array', cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
      return rows;
    }

    function replaceHeadersByPosition(dataRows, canonicalHeaders) {
      // Ensure dataRows[0] exists and replace it with canonicalHeaders (by position)
      if (!dataRows.length) return dataRows;
      const width = Math.max((dataRows[0] || []).length, canonicalHeaders.length);
      const newHeader = [];
      for (let i = 0; i < width; i++) newHeader[i] = canonicalHeaders[i] ?? (dataRows[0][i] ?? ('col' + (i+1)));
      dataRows[0] = newHeader;
      return dataRows;
    }

    function buildDaily(rows, dateKey, salesKey) {
      const daily = new Map();
      for (const r of rows) {
        const d = parseDate(r[dateKey]);
        let v = r[salesKey];
        if (d == null || v == null) continue;
        if (typeof v === 'string') v = Number(v.replace(/[^\d.-]/g, ''));
        if (!isFinite(v)) continue;
        const ds = ymd(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
        daily.set(ds, (daily.get(ds) || 0) + v);
      }
      return Array.from(daily.entries()).sort((a,b) => a[0].localeCompare(b[0]));
    }

    function sumWindow(entries, endStr, days) {
      const end = new Date(endStr + 'T00:00:00');
      const start = new Date(end); start.setDate(end.getDate() - (days - 1));
      let sum = 0;
      for (const [ds, v] of entries) {
        const d = new Date(ds + 'T00:00:00');
        if (d >= start && d <= end) sum += v;
      }
      return sum;
    }

    function populateDates(entries) {
      const sel = document.getElementById('endDate');
      sel.innerHTML = '';
      for (const [ds] of entries) {
        const opt = document.createElement('option'); opt.value = ds; opt.textContent = ds; sel.appendChild(opt);
      }
      if (entries.length) sel.value = entries[entries.length - 1][0];
      document.getElementById('lastDate').textContent = entries.length ? `Última fecha: ${entries[entries.length - 1][0]}` : '';
    }

    let chart;
    function renderChart(entries) {
      const ctx = document.getElementById('chart');
      const labels = entries.map(e => e[0]);
      const data = entries.map(e => e[1]);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Ventas diarias (COP)', data, tension: 0.2 }]},
        options: {
          responsive: true, plugins: { legend: { display: false } },
          scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } }, y: { beginAtZero: true } }
        }
      });
    }

    function refreshKpis(entries) {
      const endStr = document.getElementById('endDate').value;
      document.getElementById('kpi1').textContent  = fmtCOP(sumWindow(entries, endStr, 1));
      document.getElementById('kpi7').textContent  = fmtCOP(sumWindow(entries, endStr, 7));
      document.getElementById('kpi30').textContent = fmtCOP(sumWindow(entries, endStr, 30));
    }

    (async function init() {
      try {
        setStatus('Cargando headers y datos…');
        // 1) Load canonical headers (AoA) and extract first row
        const hdrAoa = await loadAoaFromXlsx(HEADERS_FILE);
        if (!hdrAoa.length) throw new Error('headers.xlsx está vacío.');
        const canonicalHeaders = (hdrAoa[0] || []).map(x => (x ?? '').toString());
        log('Headers canónicos:', canonicalHeaders.join(' | '));

        // 2) Load data as AoA, replace header row by position
        const dataAoa = await loadAoaFromXlsx(EXCEL_FILE);
        if (!dataAoa.length) throw new Error('reporte_utilidad.xlsx está vacío.');
        const origHeaders = (dataAoa[0] || []).map(x => (x ?? '').toString());
        log('Headers originales:', origHeaders.join(' | '));

        replaceHeadersByPosition(dataAoa, canonicalHeaders);
        const rows = aoaToObjects(dataAoa);
        const effectiveHeaders = Object.keys(rows[0] || {});
        log('Headers efectivos:', effectiveHeaders.join(' | '));

        // 3) Detect keys
        const dateKey  = findKey(effectiveHeaders, DATE_KEY_CANDIDATES) || effectiveHeaders[0];
        const salesKey = findKey(effectiveHeaders, SALES_KEY_CANDIDATES) || effectiveHeaders.find(h => h.toLowerCase().includes('total')) || effectiveHeaders[1];
        log('Usando columnas → fecha:', dateKey, ', ventas:', salesKey);

        // 4) Build aggregates + chart
        const entries = buildDaily(rows, dateKey, salesKey);
        if (!entries.length) { setStatus('No se encontraron filas con datos válidos.', 'warn'); return; }

        populateDates(entries);
        renderChart(entries);
        refreshKpis(entries);
        document.getElementById('endDate').addEventListener('change', () => refreshKpis(entries));
        setStatus('OK', 'ok');
      } catch (e) {
        setStatus('Error: ' + e.message, 'err');
        log('Error:', e.stack || e.message);
      }
    })();
  </script>
</body>
</html>
