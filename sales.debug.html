<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monki — Sales Dashboard (DEBUG)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0f172a; color:var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:16px; padding:16px; margin-bottom:16px; }
    .title { font-size: 22px; margin: 0 0 8px; }
    .muted { color:#94a3b8; }
    pre { background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:12px; overflow:auto; color:#cbd5e1; font-size:12px; }
    code { color:#cbd5e1; }
    .ok { color:#34d399; }
    .warn { color:#fbbf24; }
    .err { color:#f87171; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .kpi { font-size: 26px; font-weight: 700; }
    label, select, input, button { font-size:14px; }
    select, input, button { background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:8px 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Sales Dashboard (DEBUG)</h1>
    <p class="muted">Esta versión imprime diagnósticos para encontrar por qué no cargan los CSV.</p>

    <div class="card">
      <div class="title">Filtros</div>
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
        <div><label>Inicio</label><br><input id="startDate" type="date"></div>
        <div><label>Fin</label><br><input id="endDate" type="date"></div>
        <div><label>Producto</label><br><select id="productFilter"></select></div>
        <div><button id="applyBtn">Aplicar</button></div>
      </div>
    </div>

    <div class="card">
      <div class="title">KPIs</div>
      <div class="grid">
        <div>Total Sales (COP)<div id="k_totalSales" class="kpi">$0</div></div>
        <div>Total Invoices<div id="k_totalInvoices" class="kpi">0</div></div>
        <div>Average Ticket<div id="k_avgTicket" class="kpi">$0</div></div>
        <div>Total Icecreams<div id="k_totalIcecreams" class="kpi">0</div></div>
        <div>Avg Toppings / Icecream<div id="k_avgToppings" class="kpi">0</div></div>
        <div>Avg Net Profit %<div id="k_avgNetProfit" class="kpi">0%</div></div>
      </div>
    </div>

    <div class="card">
      <div class="title">Estado</div>
      <pre id="status">Iniciando…</pre>
    </div>

    <div class="card">
      <div class="title">Muestras</div>
      <pre id="sample"></pre>
    </div>
  </div>

<script>
const HEADERS_FILE='headers.csv';
const DATA_FILE='reporte_utilidad.csv';

// Columnas (según tu especificación actual)
const COL_TOTAL_GROSS = 'total_purchase_per_product'; // ajustado a tu preferencia
const COL_INVOICE     = 'invoice';
const COL_TOTAL_PURCH = 'total_purchase';
const COL_CATEGORY    = 'category';
const COL_QUANTITY    = 'quantity';
const COL_GROSS_PROD  = 'gross_prodit';

const DATE_KEY_CANDIDATES = ['date','fecha','fecha_creacion','fecha creación'];
const PRODUCT_KEY_CANDS   = ['product','producto','item','item_name','nombre_producto'];

const $status = document.getElementById('status');
const $sample = document.getElementById('sample');

function log(msg, cls){
  $status.textContent += (cls ? '\\n['+cls+'] ' : '\\n') + msg;
}
function setStatus(msg){ $status.textContent = msg; }

function parseDateDMYStrict(v) {
  if (v instanceof Date) return v;
  if (typeof v !== 'string') return null;
  const s = v.trim();
  const m = s.match(/^\\s*(\\d{1,2})[\\/\\-.](\\d{1,2})[\\/\\-.](\\d{2,4})(?:\\s.*)?$/);
  if (!m) return null;
  let dd = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  let yy = m[3].length === 2 ? 2000 + parseInt(m[3], 10) : parseInt(m[3], 10);
  if (mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
  const d = new Date(yy, mm - 1, dd);
  if (d.getFullYear() !== yy || d.getMonth() !== mm - 1 || d.getDate() !== dd) return null;
  return d;
}
function isoLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function fmtCOP(v){ return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(v||0); }
function fmtPct(v){ return (v||0).toFixed(1).replace('.',',') + '%'; }
function num(x){ if(x==null)return 0; if(typeof x==='number')return isFinite(x)?x:0; if(typeof x==='string'){const n=Number(x.replace(/[^0-9.-]/g,'')); return isFinite(n)?n:0;} return 0; }
function findKey(headers, cands){ const lower=headers.map(h=>String(h||'').trim().toLowerCase()); for(const c of cands){ const i=lower.indexOf(c.toLowerCase()); if(i!==-1) return headers[i]; } return null; }

function parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url+'?v='+Date.now(),{
      download:true, header:false, dynamicTyping:false, skipEmptyLines:true,
      complete:res=>resolve(res.data),
      error:err=>reject(err)
    });
  });
}

(async function init(){
  try{
    setStatus('Cargando CSV…');

    const hdrRows  = await parseCSV(HEADERS_FILE);
    log(`headers.csv filas: ${hdrRows.length}`,'ok');
    if(!hdrRows.length) throw new Error('headers.csv vacío');

    const dataRows = await parseCSV(DATA_FILE);
    log(`reporte_utilidad.csv filas: ${dataRows.length}`,'ok');
    if(!dataRows.length) throw new Error('reporte_utilidad.csv vacío');

    // Reemplazar encabezados por la primera fila de headers.csv
    const canonical = hdrRows[0].map(x=>(x??'').toString());
    log('Encabezados canónicos (headers.csv[0]): '+JSON.stringify(canonical));
    const width = Math.max((dataRows[0]||[]).length, canonical.length);
    dataRows[0] = Array.from({length: width}, (_,i)=> canonical[i] ?? (dataRows[0]||[])[i] ?? ('col'+(i+1)));

    const headers = dataRows[0];
    log('Encabezados usados: '+JSON.stringify(headers),'ok');

    const rows = dataRows.slice(1).map(r=>{const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });

    // Mostrar primeras 3 filas
    $sample.textContent = JSON.stringify(rows.slice(0,3), null, 2);

    // Detección de claves
    const dateKey    = findKey(headers, DATE_KEY_CANDIDATES) || headers[0];
    const productKey = findKey(headers, PRODUCT_KEY_CANDS)   || 'product';
    log(`dateKey: ${dateKey}, productKey: ${productKey}`,'ok');

    const parsedDates = rows.map(r=>parseDateDMYStrict(r[dateKey]));
    const invalidCount = parsedDates.filter(d=>!d).length;
    const dates = parsedDates.filter(Boolean).sort((a,b)=>a-b);
    log(`Fechas válidas: ${dates.length}, inválidas: ${invalidCount}`,(invalidCount? 'warn':'ok'));
    if(!dates.length) throw new Error('No hay fechas válidas en DD/MM/YYYY.');

    const maxDate = dates[dates.length-1];
    const minDefault = new Date(maxDate); minDefault.setDate(maxDate.getDate()-29);
    document.getElementById('startDate').value = isoLocal(minDefault);
    document.getElementById('endDate').value   = isoLocal(maxDate);
    log(`Rango por defecto: ${isoLocal(minDefault)} a ${isoLocal(maxDate)}`,'ok');

    const $prod = document.getElementById('productFilter');
    const uniq = Array.from(new Set(rows.map(r=> (r[productKey]??'').toString().trim()))).filter(s=>s.length>0).sort((a,b)=>a.localeCompare(b));
    const optAll = document.createElement('option'); optAll.value='__ALL__'; optAll.textContent='Todos los productos'; $prod.appendChild(optAll);
    uniq.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; $prod.appendChild(o); });
    $prod.value='__ALL__';
    log(`Productos únicos: ${uniq.length}`,'ok');

    function applyFilters(){
      const start = new Date(document.getElementById('startDate').value+'T00:00:00');
      const end   = new Date(document.getElementById('endDate').value  +'T23:59:59');
      const prod  = document.getElementById('productFilter').value;

      const filtered = rows.filter((r, idx)=>{
        const d = parsedDates[idx];
        if(!d) return false;
        if(d < start || d > end) return false;
        if(prod !== '__ALL__'){
          const p = (r[productKey]??'').toString().trim();
          if(p !== prod) return false;
        }
        return true;
      });

      computeKPIs(filtered);
      log(`Filtradas: ${filtered.length} filas`,'ok');
    }

    function computeKPIs(data){
      let totalSalesCOP=0, totalIcecreams=0, totalToppings=0, sumGrossProdit=0;
      const invoices = new Set();
      const invoicePurchase = new Map();

      for(const r of data){
        totalSalesCOP += num(r[COL_TOTAL_GROSS]);
        sumGrossProdit += num(r[COL_GROSS_PROD]);

        const inv = (r[COL_INVOICE]??'').toString();
        if(inv) invoices.add(inv);

        const tp = num(r[COL_TOTAL_PURCH]);
        if(inv) invoicePurchase.set(inv, tp);

        const cat = (r[COL_CATEGORY]??'').toString().trim().toLowerCase();
        const qty = num(r[COL_QUANTITY]);
        if(cat === 'helados') totalIcecreams += qty;
        else if(cat === 'toppings') totalToppings += qty;
      }

      const totalInvoices = invoices.size;
      let avgTicket = 0;
      if(totalInvoices>0){
        let s=0; for(const inv of invoices){ s += (invoicePurchase.get(inv)||0); }
        avgTicket = s/totalInvoices;
      }
      const avgToppings = totalIcecreams>0 ? (totalToppings/totalIcecreams) : 0;
      const avgNetProfitPct = totalSalesCOP>0 ? (sumGrossProdit/totalSalesCOP)*100 : 0;

      document.getElementById('k_totalSales').textContent     = fmtCOP(totalSalesCOP);
      document.getElementById('k_totalInvoices').textContent  = totalInvoices.toLocaleString('es-CO');
      document.getElementById('k_avgTicket').textContent      = fmtCOP(avgTicket);
      document.getElementById('k_totalIcecreams').textContent = totalIcecreams.toLocaleString('es-CO');
      document.getElementById('k_avgToppings').textContent    = (Math.round(avgToppings*100)/100).toLocaleString('es-CO');
      document.getElementById('k_avgNetProfit').textContent   = fmtPct(avgNetProfitPct);
    }

    document.getElementById('applyBtn').addEventListener('click', applyFilters);
    applyFilters();
    log('Listo. Si algo falla, revisa el bloque "Estado" y "Muestras".','ok');
  }catch(e){
    log('Error: '+(e && e.message ? e.message : e),'err');
  }
})();
</script>
</body>
</html>
